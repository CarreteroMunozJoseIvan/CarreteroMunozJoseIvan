from pathlib import Path
import re
import os
import pandas as pd
import extract_msg  # pip install extract_msg
from email import policy
from email.parser import BytesParser

# === Rutas base ===
BASE_DIR = Path(r"C:\Users\imunoz011\OneDrive - Everest Reinsurance\Documents\Aon GPF Automation")
CORREOS_DIR = BASE_DIR / "Correos"
FINAL_SLIPS_DIR = BASE_DIR / "Final_Slips"

FINAL_SLIPS_DIR.mkdir(exist_ok=True)  # por si no existe todavÃ­a

# === Utils ===

def safe_folder_name(name: str) -> str:
    """Quita caracteres no vÃ¡lidos en Windows y limpia espacios."""
    invalid = r'<>:"/\|?*'
    for ch in invalid:
        name = name.replace(ch, "_")
    name = re.sub(r"\s+", " ", name).strip()
    return name[:150]

def title_case_name(name: str) -> str:
    """Convierte el nombre a 'tÃ­tulo': primera letra de cada palabra en mayÃºscula."""
    return " ".join(w.capitalize() for w in name.lower().split())

def read_email_body(path: Path) -> str:
    """Devuelve subject + body como texto plano, soporta .msg y .eml."""
    if path.suffix.lower() == ".msg":
        msg = extract_msg.Message(str(path))
        subject = msg.subject or ""
        body = msg.body or ""
        return subject + "\n" + body

    elif path.suffix.lower() == ".eml":
        with open(path, "rb") as f:
            msg = BytesParser(policy=policy.default).parse(f)
        subject = msg["subject"] or ""
        # payload puede ser multiparte
        if msg.is_multipart():
            parts = []
            for part in msg.walk():
                if part.get_content_type() == "text/plain":
                    parts.append(part.get_content())
            body = "\n".join(parts)
        else:
            body = msg.get_content()
        return (subject or "") + "\n" + (body or "")

    else:
        # otros tipos: intenta leer como texto plano
        try:
            return path.read_text(encoding="utf-8", errors="ignore")
        except Exception:
            return ""

def extract_name_and_layer(text: str):
    """
    Busca la lÃ­nea tipo:
      'Aon GPF â€“ new ONE NEW ZEALAND GROUP LIMITED - 200m xs 100m - TAL'
    y devuelve (nombre, layer).
    """
    # 1) Busca una lÃ­nea que contenga 'Aon GPF' y varios '-'
    line = None
    for ln in text.splitlines():
        if "Aon GPF" in ln and "-" in ln:
            line = ln
            break
    if line is None:
        return None, None

    # 2) Intenta regex usando 'new ... - layer -'
    m = re.search(r"new\s+(.+?)\s*-\s*([^-\n\r]+)\s*-\s*", line, flags=re.I)
    if not m:
        # Plan B: separar por '-' y coger las partes centrales
        parts = [p.strip() for p in line.split("-") if p.strip()]
        if len(parts) >= 3:
            # algo tipo: ['Aon GPF â€“ new ONE NEW ZEALAND GROUP LIMITED', '200m xs 100m', 'TAL']
            # saca el nombre quitando el prefijo 'Aon GPF ... new'
            name_part = parts[0]
            name_part = re.sub(r"^.*new\s+", "", name_part, flags=re.I)
            name_raw = name_part.strip()
            layer_raw = parts[1].strip()
        else:
            return None, None
    else:
        name_raw = m.group(1).strip()
        layer_raw = m.group(2).strip()

    if not name_raw or not layer_raw:
        return None, None

    return name_raw, layer_raw

# === Proceso principal ===

records = []

for email_file in sorted(CORREOS_DIR.iterdir()):
    if not email_file.is_file():
        continue
    if email_file.suffix.lower() not in {".msg", ".eml", ".txt"}:
        continue

    text = read_email_body(email_file)
    name_raw, layer_raw = extract_name_and_layer(text)

    if not name_raw or not layer_raw:
        print(f"âš ï¸ No se pudo extraer nombre/layer de: {email_file.name}")
        continue

    # Formato carpeta: Nombre en tÃ­tulo + ' - ' + layer
    name_formatted = title_case_name(name_raw)
    folder_name = f"{name_formatted} - {layer_raw}"
    folder_name = safe_folder_name(folder_name)

    target_folder = FINAL_SLIPS_DIR / folder_name
    target_folder.mkdir(parents=True, exist_ok=True)

    print(f"âœ… {email_file.name} -> '{name_formatted}' | '{layer_raw}'  â†’  {target_folder}")

    records.append({
        "EmailFile": email_file.name,
        "Name": name_formatted,
        "Layer": layer_raw,
        "FolderPath": str(target_folder),
    })

# === Guardar las 2 columnas en un Excel si quieres ===

if records:
    df = pd.DataFrame(records)
    # solo nombre y layer (puedes dejar FolderPath tambiÃ©n si te interesa)
    df_out = df[["Name", "Layer"]]
    output_excel = BASE_DIR / "Folders_Structures.xlsx"
    df_out.to_excel(output_excel, index=False)
    print(f"\nðŸ“„ Excel generado con Name/Layer:\n{output_excel}")
