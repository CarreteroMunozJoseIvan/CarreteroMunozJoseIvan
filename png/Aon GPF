from pathlib import Path
import pandas as pd

# 1) Define tu base directory
base_dir = Path(r"C:\Users\lmunoz01\OneDrive - Everest Reinsurance\Documents\Aon GPF Automation")

# 2) Moverse a la carpeta "Final_slips"
endpoint = "Final_slips"
final_slips_dir = base_dir / endpoint   # m√°s limpio que joinpath + Path

if not final_slips_dir.exists():
    raise FileNotFoundError(f"‚ùå Folder not found: {final_slips_dir}")

print(f"üìÅ Scanning base folder: {final_slips_dir}\n")

# AQU√ç guardaremos todas las filas de todos los slips
all_rows = []

# 3) Loop por cada subcarpeta (cada cuenta / slip folder)
for slip_folder in sorted(final_slips_dir.iterdir()):
    if not slip_folder.is_dir():
        continue

    print(f"\n‚û°Ô∏è Folder: {slip_folder.name}")

    # 4) Buscar PDFs dentro de la carpeta (solo deber√≠a haber 1)
    pdf_files = list(slip_folder.glob("*.pdf"))  # ya no uso rglob, solo nivel actual

    if not pdf_files:
        print("   -> No PDFs found here")
        continue

    if len(pdf_files) > 1:
        print(f"   ‚ö†Ô∏è Found {len(pdf_files)} PDFs, usar√© solo el primero: {pdf_files[0].name}")

    pdf_path = pdf_files[0]  # usamos SOLO el slip (primer pdf)
    full_path = pdf_path.resolve()

    print(f"   üìÑ Slip PDF: {pdf_path.name}")
    # 5) Sacar texto
    text = extract_text_pdf_robust(full_path)

    # 6) Pasar el texto al parser para generar la fila del DataFrame
    df_row = slip_text_to_dataframe(text, source_file=pdf_path.name)

    # (Opcional) a√±adir el nombre de la carpeta por si te sirve como columna
    df_row["folder_name"] = slip_folder.name

    # Guardamos la fila
    all_rows.append(df_row)

    # (Opcional) preview
    print(f"   ‚úÖ Extracted {len(text)} characters")

# 7) Juntar todo en un solo DataFrame
if all_rows:
    df_all_slips = pd.concat(all_rows, ignore_index=True)
    print("\n‚úÖ DataFrame final con todos los slips:")
    display(df_all_slips)          # si est√°s en Jupyter
    # o simplemente:
    # print(df_all_slips)
else:
    print("\n‚ö†Ô∏è No se ha generado ninguna fila (¬øno hab√≠a slips?)")
